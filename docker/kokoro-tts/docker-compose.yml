services:
  kokoro-tts:
    build:
      context: ../../src/kokoro.local
      dockerfile: ../../docker/kokoro-tts/Dockerfile
    container_name: kokoro-tts
    gpus: all
    volumes:
      - ../../src/kokoro.local:/app
      - kokoro_models:/models
    ports:
      - "${KOKORO_SPEECH_PORT:-8004}:5000"  # Single port for REST + WebSocket + health
    environment:
      - KOKORO_REST_PORT=5000
      - LOG_LEVEL=${KOKORO_LOG_LEVEL:-INFO}
      - KOKORO_TTS_DEFAULT_LANGUAGE=${KOKORO_TTS_DEFAULT_LANGUAGE:-en-US}
      - KOKORO_TTS_DEFAULT_VOICE=${KOKORO_TTS_DEFAULT_VOICE:-af_sarah}
      - KOKORO_TTS_DEFAULT_SPEED=${KOKORO_TTS_DEFAULT_SPEED:-1.0}
      - KOKORO_TTS_SAMPLE_RATE=${KOKORO_TTS_SAMPLE_RATE:-22050}
      - KOKORO_TTS_BLEND_RATIO=${KOKORO_TTS_BLEND_RATIO:-0.5}
      - KOKORO_MODEL_URL=${KOKORO_MODEL_URL:-https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/kokoro-v1.0.onnx}
      - KOKORO_VOICES_URL=${KOKORO_VOICES_URL:-https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/voices-v1.0.bin}
      - KOKORO_MODEL_PATH=${KOKORO_MODEL_PATH:-/models/kokoro/kokoro-v1.0.onnx}
      - KOKORO_VOICES_PATH=${KOKORO_VOICES_PATH:-/models/kokoro/voices-v1.0.bin}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
volumes:
  kokoro_models:
networks:
  voicebot-network:
    external: true